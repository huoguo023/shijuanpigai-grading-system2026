<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ç¬¬ä¸ƒã€å…«è¯¾ï¼šå¼¦ä¸å°ä¹å™¨ - ç§‘å­¦å¤§é—¯å…³</title>
    <style>
        :root {
            --bg-color: #FFF3E0; /* æ¸©æš–æœ¨è‰²èƒŒæ™¯ï¼Œå‘¼åº”ä¹å™¨ */
            --card-bg: #FFFFFF;
            --primary: #FF5722; /* çƒ­æƒ…æ©™ */
            --high-tone: #E91E63; /* é«˜éŸ³è‰² */
            --low-tone: #3F51B5; /* ä½éŸ³è‰² */
            --text: #3E2723;
            --font-main: "Microsoft YaHei", -apple-system, sans-serif;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            font-family: var(--font-main);
            background-color: var(--bg-color);
            color: var(--text);
            margin: 0;
            padding: 10px;
            min-height: 100vh;
            background-image: radial-gradient(#FFE0B2 15%, transparent 16%);
            background-size: 25px 25px;
        }

        .container {
            width: 100%;
            max-width: 800px;
            margin: 0 auto;
            background: var(--card-bg);
            border-radius: 20px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            padding: 20px;
            text-align: center;
            border: 4px solid #FFCC80;
            overflow: hidden;
        }

        h1 { color: #E65100; margin-top: 0; font-size: 1.6em; margin-bottom: 5px; }
        .subtitle { color: #795548; font-size: 1em; margin-bottom: 15px; font-weight: bold; }

        /* åŒºåŸŸåˆ‡æ¢ */
        .section { display: none; animation: slideUp 0.4s ease-out; }
        .active { display: block; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        /* çŸ¥è¯†ç‚¹å¡ç‰‡ */
        .knowledge-box {
            background: #FFF8E1;
            border-radius: 12px;
            padding: 15px;
            text-align: left;
            border-left: 5px solid #FF9800;
            margin-bottom: 20px;
        }
        .knowledge-box h3 { margin: 0 0 10px 0; color: #EF6C00; border-bottom: 1px dashed #FFE0B2; padding-bottom: 5px; }
        .k-point { margin-bottom: 8px; font-size: 1em; line-height: 1.6; }
        .highlight { color: #C2185B; font-weight: bold; background: #F8BBD0; padding: 0 4px; border-radius: 3px; }
        .high-mark { color: var(--high-tone); font-weight: bold; }
        .low-mark { color: var(--low-tone); font-weight: bold; }

        /* SVG æ¼”ç¤ºåŒº */
        .svg-stage {
            background: #FFF;
            border: 2px dashed #FFAB91;
            border-radius: 10px;
            padding: 10px;
            margin: 15px 0;
            text-align: center;
            position: relative;
        }
        .svg-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 10px;
        }
        .svg-caption { font-size: 0.9em; color: #8D6E63; margin-top: 5px; font-style: italic; }

        .ctrl-btn {
            background: #FF5722; color: white; border: none; padding: 6px 15px; 
            border-radius: 15px; margin: 3px; cursor: pointer; font-size: 0.85em;
            box-shadow: 0 3px 0 #E64A19; transition: 0.1s;
        }
        .ctrl-btn:active { transform: translateY(2px); box-shadow: 0 1px 0 #E64A19; }

        /* æŒ‰é’® */
        .btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 12px 0;
            width: 100%;
            font-size: 1.1em;
            border-radius: 50px;
            cursor: pointer;
            margin: 15px 0;
            font-weight: bold;
            box-shadow: 0 4px 0 #E64A19;
            transition: 0.1s;
        }
        .btn:active { transform: translateY(3px); box-shadow: 0 1px 0 #E64A19; }
        .btn-next { background: #FFB74D; box-shadow: 0 4px 0 #F57C00; color: #3E2723; }

        /* é¢˜ç›®åŒº */
        .progress-container { height: 10px; background: #ECEFF1; border-radius: 5px; margin-bottom: 5px; overflow: hidden; }
        .progress-bar { height: 100%; background: #FF5722; width: 0%; transition: width 0.3s; }
        
        .question-card { background: #FAFAFA; border-radius: 10px; padding: 15px; text-align: left; border: 2px solid #E0E0E0; margin-top: 10px; }
        .q-tag { background: #FFCCBC; color: #BF360C; padding: 3px 8px; border-radius: 4px; font-size: 0.8em; font-weight: bold; margin-right: 5px; }
        .q-content { font-size: 1.2em; font-weight: bold; margin: 10px 0 20px 0; line-height: 1.4; }

        /* é€‰é¡¹ */
        .option-item {
            background: white; border: 2px solid #FFCCBC; padding: 12px; border-radius: 8px;
            margin-bottom: 10px; cursor: pointer; transition: 0.2s;
        }
        .option-item.selected { background: #FFAB91; border-color: #FF5722; font-weight: bold; color: #BF360C; }

        .fill-input { border: none; border-bottom: 3px solid #FF5722; background: transparent; width: 120px; text-align: center; font-size: 1.2em; color: #E64A19; border-radius: 0; }

        /* è¿çº¿é¢˜ */
        .match-row { display: flex; justify-content: space-between; gap: 10px; margin-bottom: 10px; }
        .match-col { width: 48%; display: flex; flex-direction: column; gap: 10px; }
        .match-btn {
            padding: 10px; background: #FFF; border: 2px solid #BCAAA4; border-radius: 8px;
            text-align: center; cursor: pointer; font-size: 0.9em;
        }
        .match-btn.selected { background: #FFF59D; border-color: #FBC02D; transform: scale(1.05); }
        .match-btn.matched { background: #C8E6C9; border-color: #43A047; opacity: 0.6; pointer-events: none; }

        /* é”™é¢˜è§£æ */
        .wrong-item { background: #FFEBEE; border-left: 4px solid #EF5350; padding: 10px; margin-bottom: 10px; text-align: left; border-radius: 4px; }
        .score-display { font-size: 4em; color: #FF5722; font-weight: bold; margin: 10px 0; }

    </style>
</head>
<body>

    <!-- 1. å¤ä¹ åŒº -->
    <div id="section-review" class="container section active">
        <h1>ğŸ¸ çŸ¥è¯†å¤ä¹ </h1>
        <p class="subtitle">ç¬¬ä¸ƒè¯¾ï¼šå¼¦çš„éŸ³é«˜ & ç¬¬å…«è¯¾ï¼šåˆ¶ä½œå°ä¹å™¨</p>

        <!-- çŸ¥è¯†ç‚¹ 1: å¼¦ä¹å™¨ -->
        <div class="knowledge-box">
            <h3>1. å¼¦ä¹å™¨çš„ç§˜å¯†</h3>
            <div class="k-point">ğŸ» <strong>ä¹å™¨</strong>ï¼šäºŒèƒ¡ã€å°æç´ã€å‰ä»–ï¼ˆé <span class="highlight">å¼¦æŒ¯åŠ¨</span>å‘å£°ï¼‰ã€‚</div>
            <div class="svg-stage">
                <div class="svg-grid">
                    <svg width="100%" height="80" viewBox="0 0 100 80">
                        <text x="50" y="70" text-anchor="middle" font-size="10">å‰ä»–</text>
                        <path d="M30,10 Q20,40 30,70 L70,70 Q80,40 70,10 L50,5 Z" fill="#8D6E63" stroke="#5D4037"/>
                        <line x1="45" y1="10" x2="45" y2="70" stroke="#FFF" stroke-width="1"/>
                        <line x1="55" y1="10" x2="55" y2="70" stroke="#FFF" stroke-width="1"/>
                    </svg>
                    <svg width="100%" height="80" viewBox="0 0 100 80">
                        <text x="50" y="70" text-anchor="middle" font-size="10">äºŒèƒ¡</text>
                        <rect x="45" y="10" width="10" height="50" fill="#3E2723"/>
                        <path d="M35,50 L65,50 L65,65 L35,65 Z" fill="#5D4037"/>
                        <line x1="50" y1="10" x2="50" y2="50" stroke="#FFF"/>
                    </svg>
                </div>
            </div>
        </div>

        <!-- çŸ¥è¯†ç‚¹ 2-5: å¼¦çš„å˜åŒ–è§„å¾‹ (æ ¸å¿ƒé‡ç‚¹) -->
        <div class="knowledge-box">
            <h3>2. æ€æ ·è®©å¼¦å‘å‡ºé«˜ä½ä¸åŒçš„å£°éŸ³ï¼Ÿ</h3>
            <p style="font-size:0.9em; color:#777;">ç‚¹å‡»æŒ‰é’®è§‚å¯Ÿå¼¦çš„æŒ¯åŠ¨ï¼</p>
            
            <div class="k-point">ğŸ“ <strong>é•¿çŸ­</strong>ï¼šæ‰‹æŒ‡æŒ‰å‹æ”¹å˜æŒ¯åŠ¨é•¿åº¦ã€‚
                <br>æŒ¯åŠ¨éƒ¨åˆ†<span class="low-mark">é•¿</span> â†’ æ…¢ â†’ <span class="low-mark">ä½éŸ³</span>
                <br>æŒ¯åŠ¨éƒ¨åˆ†<span class="high-mark">çŸ­</span> â†’ å¿« â†’ <span class="high-mark">é«˜éŸ³</span>
            </div>
            <div class="svg-stage">
                <button class="ctrl-btn" onclick="animString('long')">é•¿å¼¦(ä½)</button>
                <button class="ctrl-btn" onclick="animString('short')">çŸ­å¼¦(é«˜)</button>
                <svg width="100%" height="60" viewBox="0 0 300 60" id="svg-string-len">
                    <line x1="20" y1="30" x2="280" y2="30" stroke="#9E9E9E" stroke-width="2"/>
                    <!-- å¼¦ (åŠ¨æ€) -->
                    <path id="str-len-path" d="M20,30 L280,30" stroke="#FF5722" stroke-width="3" fill="none"/>
                    <!-- æ‰‹æŒ‡ -->
                    <circle id="finger" cx="-20" cy="30" r="8" fill="#795548" opacity="0"/>
                    <text x="20" y="55" font-size="10">ç´æ•</text>
                    <text x="280" y="55" font-size="10">ç´ç </text>
                </svg>
            </div>

            <div class="k-point">ğŸ”§ <strong>æ¾ç´§</strong>ï¼šè°ƒèŠ‚æ—‹é’®ã€‚
                <br>å¼¦è¶Š<span class="low-mark">æ¾</span> â†’ æ…¢ â†’ <span class="low-mark">ä½éŸ³</span>
                <br>å¼¦è¶Š<span class="high-mark">ç´§</span> â†’ å¿« â†’ <span class="high-mark">é«˜éŸ³</span>
            </div>
            <div class="svg-stage">
                <button class="ctrl-btn" onclick="animStringTight('loose')">æ¾å¼¦(ä½)</button>
                <button class="ctrl-btn" onclick="animStringTight('tight')">ç´§å¼¦(é«˜)</button>
                <svg width="100%" height="50" viewBox="0 0 300 50">
                    <path id="str-tight-path" d="M20,25 L280,25" stroke="#3F51B5" stroke-width="3" fill="none"/>
                    <text id="tight-label" x="150" y="45" text-anchor="middle" font-size="10">ç‚¹å‡»æŒ‰é’®</text>
                </svg>
            </div>

            <div class="k-point">ğŸ§¶ <strong>ç²—ç»†</strong>ï¼šä¸åŒç²—ç»†çš„ç´å¼¦ã€‚
                <br>å¼¦è¶Š<span class="low-mark">ç²—</span> â†’ æ…¢ â†’ <span class="low-mark">ä½éŸ³</span>
                <br>å¼¦è¶Š<span class="high-mark">ç»†</span> â†’ å¿« â†’ <span class="high-mark">é«˜éŸ³</span>
            </div>
            <div class="svg-stage">
                <div class="svg-grid">
                    <div>
                        <svg width="100%" height="40" viewBox="0 0 100 40">
                            <path d="M10,20 Q50,25 90,20 T90,20" stroke="#5D4037" stroke-width="6" fill="none">
                                <animate attributeName="d" values="M10,20 Q50,25 90,20; M10,20 Q50,15 90,20; M10,20 Q50,25 90,20" dur="0.5s" repeatCount="indefinite"/>
                            </path>
                            <text x="50" y="38" text-anchor="middle" font-size="10" fill="#3F51B5">ç²—å¼¦(æ…¢/ä½)</text>
                        </svg>
                    </div>
                    <div>
                        <svg width="100%" height="40" viewBox="0 0 100 40">
                            <path d="M10,20 Q50,25 90,20 T90,20" stroke="#FF5722" stroke-width="2" fill="none">
                                <animate attributeName="d" values="M10,20 Q50,25 90,20; M10,20 Q50,15 90,20; M10,20 Q50,25 90,20" dur="0.1s" repeatCount="indefinite"/>
                            </path>
                            <text x="50" y="38" text-anchor="middle" font-size="10" fill="#E91E63">ç»†å¼¦(å¿«/é«˜)</text>
                        </svg>
                    </div>
                </div>
            </div>
        </div>

        <!-- çŸ¥è¯†ç‚¹ å…«: å°ä¹å™¨ -->
        <div class="knowledge-box">
            <h3>3. åˆ¶ä½œå°ä¹å™¨ (ç®¡ä¹å™¨ä¸æ‰“å‡»ä¹å™¨)</h3>
            <div class="k-point">ğŸ’¨ <strong>ç®¡ä¹å™¨</strong>ï¼šæ’ç®«ã€ç¬›å­ï¼ˆé <span class="highlight">ç©ºæ°”æŸ±æŒ¯åŠ¨</span>ï¼‰ã€‚</div>
            <div class="k-point">ğŸ“ <strong>æ’ç®«è§„å¾‹</strong>ï¼š
                <br>ç®¡å­<span class="low-mark">é•¿</span> â†’ ç©ºæ°”æŸ±é•¿ â†’ <span class="low-mark">ä½éŸ³</span>
                <br>ç®¡å­<span class="high-mark">çŸ­</span> â†’ ç©ºæ°”æŸ±çŸ­ â†’ <span class="high-mark">é«˜éŸ³</span>
            </div>
            <div class="svg-stage">
                <svg width="100%" height="100" viewBox="0 0 200 100">
                    <!-- é•¿ç®¡ -->
                    <rect x="40" y="10" width="20" height="80" fill="#FFF9C4" stroke="#FBC02D"/>
                    <text x="50" y="50" text-anchor="middle" font-size="10">ç©ºæ°”æŸ±é•¿</text>
                    <text x="50" y="98" text-anchor="middle" font-size="10" fill="#3F51B5">ä½éŸ³</text>
                    <!-- çŸ­ç®¡ -->
                    <rect x="140" y="10" width="20" height="40" fill="#FFF9C4" stroke="#FBC02D"/>
                    <text x="150" y="30" text-anchor="middle" font-size="10">çŸ­</text>
                    <text x="150" y="60" text-anchor="middle" font-size="10" fill="#E91E63">é«˜éŸ³</text>
                    <!-- å¹æ°” -->
                    <path d="M30,5 Q50,0 70,5" fill="none" stroke="#aaa" stroke-dasharray="2"/>
                    <text x="100" y="8" text-anchor="middle" font-size="10">å¹æ°”</text>
                </svg>
            </div>

            <div class="k-point">ğŸ¥› <strong>æ°´ç“¶ç´ (é‡ç‚¹è¾¨æ)</strong>ï¼š
                <br>ğŸ”¨ <strong>æ•²å‡»</strong>ï¼ˆç“¶+æ°´æŒ¯åŠ¨ï¼‰ï¼šæ°´<span class="low-mark">å¤š</span>(é‡) â†’ <span class="low-mark">ä½</span>ï¼›æ°´<span class="high-mark">å°‘</span> â†’ <span class="high-mark">é«˜</span>
                <br>ğŸŒ¬ï¸ <strong>å¹å¥</strong>ï¼ˆç©ºæ°”æŸ±æŒ¯åŠ¨ï¼‰ï¼šæ°´å¤š(ç©º<span class="high-mark">çŸ­</span>) â†’ <span class="high-mark">é«˜</span>ï¼›æ°´å°‘(ç©º<span class="low-mark">é•¿</span>) â†’ <span class="low-mark">ä½</span>
            </div>
            <div class="svg-stage">
                <svg width="100%" height="140" viewBox="0 0 300 140">
                    <!-- ç“¶1ï¼šæ°´å°‘ -->
                    <g transform="translate(50,20)">
                        <rect x="0" y="0" width="40" height="100" fill="#E3F2FD" stroke="#2196F3"/>
                        <rect x="0" y="70" width="40" height="30" fill="#2196F3"/> <!-- æ°´å°‘ -->
                        <text x="20" y="120" text-anchor="middle" font-size="10" fill="#E91E63">æ•²: é«˜éŸ³</text>
                        <text x="20" y="135" text-anchor="middle" font-size="10" fill="#3F51B5">å¹: ä½éŸ³</text>
                        <text x="20" y="50" text-anchor="middle" font-size="10" fill="#aaa">ç©ºæ°”é•¿</text>
                    </g>
                    <!-- ç“¶2ï¼šæ°´å¤š -->
                    <g transform="translate(210,20)">
                        <rect x="0" y="0" width="40" height="100" fill="#E3F2FD" stroke="#2196F3"/>
                        <rect x="0" y="20" width="40" height="80" fill="#2196F3"/> <!-- æ°´å¤š -->
                        <text x="20" y="120" text-anchor="middle" font-size="10" fill="#3F51B5">æ•²: ä½éŸ³</text>
                        <text x="20" y="135" text-anchor="middle" font-size="10" fill="#E91E63">å¹: é«˜éŸ³</text>
                         <text x="20" y="15" text-anchor="middle" font-size="10" fill="#aaa">ç©ºæ°”çŸ­</text>
                    </g>
                </svg>
            </div>

            <div class="k-point">ğŸµ <strong>éŸ³è°ƒç­‰çº§</strong>ï¼šä½ã€è¾ƒä½ã€è¾ƒé«˜ã€é«˜ã€‚</div>
            <div class="svg-stage">
                <svg width="100%" height="40" viewBox="0 0 300 40">
                    <rect x="10" y="20" width="60" height="10" fill="#3F51B5"/>
                    <rect x="80" y="15" width="60" height="15" fill="#5C6BC0"/>
                    <rect x="150" y="10" width="60" height="20" fill="#EC407A"/>
                    <rect x="220" y="5" width="60" height="25" fill="#E91E63"/>
                    <text x="40" y="38" text-anchor="middle" font-size="8" fill="#fff">ä½</text>
                    <text x="110" y="38" text-anchor="middle" font-size="8" fill="#fff">è¾ƒä½</text>
                    <text x="180" y="38" text-anchor="middle" font-size="8" fill="#fff">è¾ƒé«˜</text>
                    <text x="250" y="38" text-anchor="middle" font-size="8" fill="#fff">é«˜</text>
                </svg>
            </div>
        </div>

        <button class="btn" onclick="startQuiz()">è¿›å…¥35é¢˜é—¯å…³å¡”ï¼ğŸš€</button>
    </div>

    <!-- 2. é—¯å…³åŒº -->
    <div id="section-quiz" class="container section">
        <div class="progress-container">
            <div class="progress-bar" id="progressBar"></div>
        </div>
        <div style="text-align:right; font-size:0.9em; color:#E65100;">é¢˜ç›®ï¼š<span id="q-index">1</span> / 35</div>

        <div id="question-area"></div>
        
        <button class="btn btn-next" id="nextBtn" onclick="nextQuestion()">ä¸‹ä¸€é¢˜ â–¶</button>
    </div>

    <!-- 3. ç»“ç®—åŒº -->
    <div id="section-result" class="container section">
        <h1>ğŸ† é—¯å…³æˆç»©</h1>
        <div class="score-display"><span id="final-score">0</span>åˆ†</div>
        <p id="reward-text"></p>
        
        <div id="wrong-list" style="display:none;">
            <h3 style="color:#D32F2F;">âŒ é”™é¢˜è§£æ</h3>
            <!-- é”™é¢˜å†…å®¹ -->
        </div>
        <button class="btn" onclick="location.reload()">ğŸ”„ é‡æ–°æŒ‘æˆ˜</button>
    </div>

    <script>
        // --- SVG åŠ¨ç”»é€»è¾‘ ---
        
        function animString(type) {
            const path = document.getElementById('str-len-path');
            const finger = document.getElementById('finger');
            
            // æ¸…é™¤æ—§åŠ¨ç”»
            while(path.firstChild) path.removeChild(path.firstChild);
            
            const anim = document.createElementNS("http://www.w3.org/2000/svg", "animate");
            anim.setAttribute("attributeName", "d");
            anim.setAttribute("dur", type === 'short' ? "0.1s" : "0.3s"); // çŸ­å¿«é•¿æ…¢
            anim.setAttribute("repeatCount", "10");
            
            if(type === 'long') {
                // 20åˆ°280å…¨é•¿æŒ¯åŠ¨
                anim.setAttribute("values", "M20,30 Q150,10 280,30; M20,30 Q150,50 280,30; M20,30 L280,30");
                finger.setAttribute("opacity", 0);
            } else {
                // æ‰‹æŒ‡æŒ‰åœ¨ä¸­é—´(150)ï¼Œåªæœ‰150åˆ°280æŒ¯åŠ¨
                finger.setAttribute("opacity", 1);
                finger.setAttribute("cx", 150);
                // è·¯å¾„ï¼šå·¦è¾¹ç›´çº¿ï¼Œå³è¾¹æŒ¯åŠ¨
                anim.setAttribute("values", "M20,30 L150,30 Q215,20 280,30; M20,30 L150,30 Q215,40 280,30; M20,30 L280,30");
            }
            path.appendChild(anim);
            anim.beginElement();
        }

        function animStringTight(type) {
            const path = document.getElementById('str-tight-path');
            const label = document.getElementById('tight-label');
            
            while(path.firstChild) path.removeChild(path.firstChild);
            const anim = document.createElementNS("http://www.w3.org/2000/svg", "animate");
            anim.setAttribute("attributeName", "d");
            anim.setAttribute("repeatCount", "10");
            
            if(type === 'loose') {
                // æ¾ï¼šæŒ¯å¹…å¤§ï¼Œé¢‘ç‡æ…¢
                anim.setAttribute("values", "M20,25 Q150,5 280,25; M20,25 Q150,45 280,25; M20,25 L280,25");
                anim.setAttribute("dur", "0.4s");
                label.textContent = "æ¾å¼¦ -> æŒ¯åŠ¨æ…¢ -> å£°éŸ³ä½";
            } else {
                // ç´§ï¼šæŒ¯å¹…å°ï¼Œé¢‘ç‡å¿«
                anim.setAttribute("values", "M20,25 Q150,15 280,25; M20,25 Q150,35 280,25; M20,25 L280,25");
                anim.setAttribute("dur", "0.1s");
                label.textContent = "ç´§å¼¦ -> æŒ¯åŠ¨å¿« -> å£°éŸ³é«˜";
            }
            path.appendChild(anim);
            anim.beginElement();
        }

        // --- å³æ—¶åé¦ˆç³»ç»Ÿ ---
        const InstantFeedback = {
            audioCtx: null,
            encouragements: ['å¤ªæ£’äº†ï¼ç»§ç»­åŠ æ²¹ï¼ğŸŒŸ', 'ä½ çœŸèªæ˜ï¼ğŸ‘', 'å®Œå…¨æ­£ç¡®ï¼çœŸå‰å®³ï¼ğŸ¯', 'ç­”å¯¹äº†ï¼ä½ æ˜¯æœ€æ£’çš„ï¼â­', 'å¤ªä¼˜ç§€äº†ï¼ç»§ç»­ä¿æŒï¼ğŸ†', 'çœŸæ˜¯ä¸ªå°å¤©æ‰ï¼ğŸ’¡', 'å›ç­”å¾—éå¸¸å¥½ï¼ğŸ‘', 'ä½ æŒæ¡å¾—å¾ˆå¥½ï¼ğŸ“š'],
            hints: ['å†æƒ³æƒ³å“¦ï¼ä½ å¯ä»¥çš„ï¼ğŸ’ª', 'åˆ«ç°å¿ƒï¼Œå†è¯•ä¸€æ¬¡ï¼ğŸŒˆ', 'åŠ æ²¹ï¼ä»”ç»†çœ‹çœ‹é¢˜ç›®ï¼ğŸ‘€', 'æ²¡å…³ç³»ï¼Œç»§ç»­åŠªåŠ›ï¼ğŸ’«', 'å†çœ‹çœ‹çŸ¥è¯†ç‚¹å§ï¼ğŸ“–', 'ä¸è¦æ”¾å¼ƒï¼Œä½ èƒ½è¡Œï¼ğŸš€', 'æ€è€ƒä¸€ä¸‹ï¼Œä½ ä¸€å®šèƒ½æƒ³åˆ°ï¼ğŸ¤”', 'åŠ æ²¹ï¼ç›¸ä¿¡è‡ªå·±ï¼âœ¨'],
            
            init() { if (!this.audioCtx) this.audioCtx = new (window.AudioContext || window.webkitAudioContext)(); },
            
            playCorrectSound() {
                this.init(); if (this.audioCtx.state === 'suspended') this.audioCtx.resume();
                const notes = [523.25, 659.25, 783.99];
                notes.forEach((freq, i) => {
                    const osc = this.audioCtx.createOscillator(); const gain = this.audioCtx.createGain();
                    osc.connect(gain); gain.connect(this.audioCtx.destination);
                    const now = this.audioCtx.currentTime; const start = now + i * 0.1;
                    osc.frequency.value = freq; osc.type = 'sine';
                    gain.gain.setValueAtTime(0.15, start); gain.gain.exponentialRampToValueAtTime(0.01, start + 0.3);
                    osc.start(start); osc.stop(start + 0.3);
                });
            },
            
            playWrongSound() {
                this.init(); if (this.audioCtx.state === 'suspended') this.audioCtx.resume();
                const osc = this.audioCtx.createOscillator(); const gain = this.audioCtx.createGain();
                osc.connect(gain); gain.connect(this.audioCtx.destination);
                const now = this.audioCtx.currentTime;
                osc.frequency.setValueAtTime(300, now); osc.frequency.linearRampToValueAtTime(250, now + 0.2);
                osc.type = 'triangle';
                gain.gain.setValueAtTime(0.1, now); gain.gain.linearRampToValueAtTime(0, now + 0.2);
                osc.start(now); osc.stop(now + 0.2);
            },
            
            showConfetti() {
                const colors = ['#FF6B6B', '#4ECDC4', '#45B7D1', '#FFA07A', '#98D8C8', '#F7DC6F', '#BB8FCE'];
                for (let i = 0; i < 30; i++) {
                    setTimeout(() => {
                        const c = document.createElement('div'); c.className = 'confetti';
                        c.style.cssText = `width: ${Math.random() * 10 + 5}px; height: ${Math.random() * 10 + 5}px; background: ${colors[Math.floor(Math.random() * colors.length)]}; left: ${Math.random() * 100}%; top: -20px; border-radius: ${Math.random() > 0.5 ? '50%' : '0'}; animation: confetti-fall ${Math.random() * 2 + 2}s linear forwards; transform: rotate(${Math.random() * 360}deg);`;
                        document.body.appendChild(c);
                        setTimeout(() => c.remove(), 4000);
                    }, i * 30);
                }
            },
            
            showToast(message, type = 'success') {
                const toast = document.createElement('div');
                toast.className = `feedback-toast feedback-${type}`;
                toast.innerHTML = `<div class="toast-icon">${type === 'success' ? 'âœ“' : 'âœ—'}</div><div class="toast-message">${message}</div>`;
                document.body.appendChild(toast);
                setTimeout(() => toast.classList.add('show'), 10);
                setTimeout(() => { toast.classList.remove('show'); setTimeout(() => toast.remove(), 300); }, 2500);
            },
            
            onCorrect(element) {
                this.playCorrectSound(); this.showConfetti();
                const msg = this.encouragements[Math.floor(Math.random() * this.encouragements.length)];
                this.showToast(msg, 'success');
                if (element) { element.classList.add('correct-feedback'); setTimeout(() => element.classList.remove('correct-feedback'), 600); }
            },
            
            onWrong(element, hint = '') {
                this.playWrongSound();
                const msg = this.hints[Math.floor(Math.random() * this.hints.length)] + (hint ? `<br><small style="font-size:0.85em;">ğŸ’¡ ${hint}</small>` : '');
                this.showToast(msg, 'error');
                if (element) { element.classList.add('wrong-feedback'); setTimeout(() => element.classList.remove('wrong-feedback'), 500); }
            }
        };
        InstantFeedback.init();

        // --- 35é“é¢˜åº“ ---
        const quizData = [
            // 1. å¼¦ä¹å™¨åŸºç¡€ (5é¢˜)
            { type: 'mcq', q: 'é å¼¦çš„æŒ¯åŠ¨å‘å‡ºé«˜ä½ä¸åŒå£°éŸ³çš„ä¹å™¨æœ‰ï¼Ÿ', opts: ['äºŒèƒ¡ã€å‰ä»–', 'ç¬›å­ã€æ’ç®«', 'é¼“ã€é”£'], a: 0, exp: 'äºŒèƒ¡å‰ä»–æ˜¯å¼¦ä¹å™¨ã€‚' },
            { type: 'mcq', q: 'ä¸‹åˆ—ä¸å±äºå¼¦ä¹å™¨çš„æ˜¯ï¼Ÿ', opts: ['å°æç´', 'å¤ç­', 'å°å·'], a: 2, exp: 'å°å·æ˜¯ç®¡ä¹å™¨ã€‚' },
            { type: 'fill', q: 'å¼¦çš„éŸ³é«˜å’Œå¼¦æŒ¯åŠ¨éƒ¨åˆ†çš„____ã€æ¾ç´§ç¨‹åº¦ã€ç²—ç»†æœ‰å…³ã€‚', a: ['é•¿çŸ­', 'é•¿åº¦'], exp: 'ä¸‰å¤§å› ç´ ï¼šé•¿çŸ­ã€æ¾ç´§ã€ç²—ç»†ã€‚' },
            { type: 'mcq', q: 'å‰ä»–å‘å£°æ—¶ï¼ŒæŒ¯åŠ¨çš„æ˜¯ï¼Ÿ', opts: ['ç´å¼¦', 'ç´ç®±', 'ç©ºæ°”'], a: 0, exp: 'å£°æºæ˜¯ç´å¼¦ã€‚' },
            { type: 'matching', q: 'ä¹å™¨åˆ†ç±»è¿çº¿ï¼š', pairs: [{l:'å‰ä»–', r:'å¼¦ä¹å™¨'}, {l:'æ’ç®«', r:'ç®¡ä¹å™¨'}, {l:'é¼“', r:'æ‰“å‡»ä¹å™¨'}], exp: 'åŸºç¡€åˆ†ç±»ã€‚' },

            // 2. å¼¦çš„å˜åŒ–è§„å¾‹ (10é¢˜)
            { type: 'mcq', q: 'æ‰‹æŒ‡åœ¨ç´å¼¦ä¸Šç§»åŠ¨ï¼Œæ”¹å˜çš„æ˜¯å¼¦æŒ¯åŠ¨çš„ï¼Ÿ', opts: ['é•¿çŸ­', 'æ¾ç´§', 'ç²—ç»†'], a: 0, exp: 'æ‰‹æŒ‡æŒ‰å‹æ”¹å˜æŒ¯åŠ¨é•¿åº¦ã€‚' },
            { type: 'mcq', q: 'ç´å¼¦æŒ¯åŠ¨çš„éƒ¨åˆ†è¶Šé•¿ï¼Œå‘å‡ºçš„å£°éŸ³ï¼Ÿ', opts: ['è¶Šé«˜', 'è¶Šä½', 'è¶Šå¼º'], a: 1, exp: 'é•¿=æ…¢=ä½ã€‚' },
            { type: 'mcq', q: 'ç´å¼¦æŒ¯åŠ¨çš„éƒ¨åˆ†è¶ŠçŸ­ï¼Œå‘å‡ºçš„å£°éŸ³ï¼Ÿ', opts: ['è¶Šé«˜', 'è¶Šä½', 'è¶Šå¼±'], a: 0, exp: 'çŸ­=å¿«=é«˜ã€‚' },
            { type: 'mcq', q: 'æŠŠç´å¼¦æ‹§ç´§ï¼Œå‘å‡ºçš„å£°éŸ³ä¼šï¼Ÿ', opts: ['å˜é«˜', 'å˜ä½', 'å˜å¤§'], a: 0, exp: 'ç´§=å¿«=é«˜ã€‚' },
            { type: 'mcq', q: 'ç´å¼¦è¶Šæ¾ï¼Œå‘å‡ºçš„å£°éŸ³ï¼Ÿ', opts: ['è¶Šé«˜', 'è¶Šä½', 'ä¸å˜'], a: 1, exp: 'æ¾=æ…¢=ä½ã€‚' },
            { type: 'mcq', q: 'ç²—å¼¦å’Œç»†å¼¦ç›¸æ¯”ï¼Œç²—å¼¦å‘å‡ºçš„å£°éŸ³ï¼Ÿ', opts: ['é«˜', 'ä½'], a: 1, exp: 'ç²—=æ…¢=ä½ã€‚' },
            { type: 'matching', q: 'è¿çº¿å¼¦çš„è§„å¾‹ï¼š', pairs: [{l:'é•¿/æ¾/ç²—', r:'å£°éŸ³ä½'}, {l:'çŸ­/ç´§/ç»†', r:'å£°éŸ³é«˜'}], exp: 'æ ¸å¿ƒè§„å¾‹æ±‡æ€»ã€‚' },
            { type: 'mcq', q: 'æ¼”å¥äºŒèƒ¡æ—¶ï¼Œæ‰‹æŒ‡ä¸Šä¸‹ç§»åŠ¨æŒ‰å¼¦æ˜¯ä¸ºäº†è°ƒèŠ‚ï¼Ÿ', opts: ['éŸ³é«˜', 'éŸ³é‡', 'éŸ³è‰²'], a: 0, exp: 'è°ƒèŠ‚éŸ³é«˜ã€‚' },
            { type: 'fill', q: 'é€šå¸¸ç´å¼¦çš„____æ˜¯ä¸åŒçš„ï¼Œè¶Šç»†çš„å¼¦å£°éŸ³è¶Šé«˜ã€‚', a: ['ç²—ç»†'], exp: 'ç²—ç»†å½±å“éŸ³é«˜ã€‚' },
            { type: 'mcq', q: 'è¦æƒ³è®©å‰ä»–çš„å£°éŸ³å˜é«˜ï¼Œå¯ä»¥ï¼Ÿ', opts: ['æ¢æ›´é•¿çš„å¼¦', 'æŠŠå¼¦æ‹§æ¾', 'æ¢æ›´ç»†çš„å¼¦'], a: 2, exp: 'ç»†å¼¦éŸ³é«˜ã€‚' },

            // 3. åˆ¶ä½œå°ä¹å™¨ä¸ç®¡ä¹å™¨ (10é¢˜)
            { type: 'mcq', q: 'åƒæ’ç®«ã€ç¬›å­ã€å°å·ç­‰ä¹å™¨æ˜¯é ____æŒ¯åŠ¨å‘å£°çš„ã€‚', opts: ['å¼¦', 'ç©ºæ°”/ç©ºæ°”æŸ±', 'é¼“é¢'], a: 1, exp: 'ç®¡ä¹å™¨é ç©ºæ°”æŸ±æŒ¯åŠ¨ã€‚' },
            { type: 'mcq', q: 'æ’ç®«çš„ç®¡å­è¶Šé•¿ï¼Œç©ºæ°”æŸ±è¶Šé•¿ï¼Œå‘å‡ºçš„å£°éŸ³ï¼Ÿ', opts: ['è¶Šé«˜', 'è¶Šä½'], a: 1, exp: 'é•¿=ä½ã€‚' },
            { type: 'mcq', q: 'åˆ¶ä½œâ€œæ°´ç“¶ç´â€æ—¶ï¼Œæ•²å‡»ç“¶å­ï¼Œå‘å£°çš„æ˜¯ï¼Ÿ', opts: ['ç“¶å­å’Œæ°´', 'ç©ºæ°”æŸ±'], a: 0, exp: 'æ•²å‡»æ˜¯ç“¶æ°´æŒ¯åŠ¨ã€‚' },
            { type: 'mcq', q: 'æ•²å‡»æ°´ç“¶ç´ï¼Œæ°´è¶Šå¤šï¼Œå£°éŸ³ï¼Ÿ', opts: ['è¶Šé«˜', 'è¶Šä½'], a: 1, exp: 'æ°´å¤š=é‡/é•¿=ä½ã€‚' },
            { type: 'mcq', q: 'å¹å¥æ°´ç“¶ç´ï¼Œå‘å£°çš„æ˜¯ï¼Ÿ', opts: ['ç“¶å­å’Œæ°´', 'ç©ºæ°”æŸ±'], a: 1, exp: 'å¹å¥æ˜¯ç©ºæ°”æŸ±æŒ¯åŠ¨ã€‚' },
            { type: 'mcq', q: 'å¹å¥æ°´ç“¶ç´ï¼Œæ°´è¶Šå¤šï¼Œç©ºæ°”æŸ±è¶Š____ï¼Œå£°éŸ³è¶Š____ã€‚', opts: ['é•¿ï¼Œä½', 'çŸ­ï¼Œé«˜'], a: 1, exp: 'æ°´å¤šå ç©ºé—´ -> ç©ºæ°”æŸ±çŸ­ -> é«˜éŸ³ã€‚' },
            { type: 'matching', q: 'è¿çº¿æ°´ç“¶ç´è§„å¾‹ï¼š', pairs: [{l:'æ•²å‡»æ°´å¤š', r:'ä½éŸ³'}, {l:'å¹å¥æ°´å¤š', r:'é«˜éŸ³'}, {l:'å¹å¥æ°´å°‘', r:'ä½éŸ³'}], exp: 'æ•²ä¸å¹ç›¸åã€‚' },
            { type: 'fill', q: 'åƒé¼“ã€é”£ç­‰ä¹å™¨æ˜¯é ____æœ¬èº«çš„æŒ¯åŠ¨å‘å£°çš„ã€‚', a: ['ä¹å™¨', 'é¼“é¢', 'é”£é¢'], exp: 'æ‰“å‡»ä¹å™¨æ•´ä½“æŒ¯åŠ¨ã€‚' },
            { type: 'mcq', q: 'åœ¨å¸ç®¡ç®«å®éªŒä¸­ï¼Œå‰ªçŸ­å¸ç®¡ï¼Œå£°éŸ³ä¼šï¼Ÿ', opts: ['å˜é«˜', 'å˜ä½'], a: 0, exp: 'çŸ­=é«˜ã€‚' },
            { type: 'mcq', q: 'å£°éŸ³é«˜ä½çš„å˜åŒ–éŸ³è°ƒå¯åˆ†ä¸ºå‡ ä¸ªç­‰çº§ï¼Ÿ', opts: ['2ä¸ª', '4ä¸ª', '10ä¸ª'], a: 1, exp: 'ä½ã€è¾ƒä½ã€è¾ƒé«˜ã€é«˜ã€‚' },

            // 4. ç»¼åˆåº”ç”¨ (10é¢˜)
            { type: 'mcq', q: 'ä¸‹åˆ—åšæ³•èƒ½è®©æ©¡çš®ç­‹å‘å‡ºæœ€é«˜å£°éŸ³çš„æ˜¯ï¼Ÿ', opts: ['æ¾æ¾åœ°æ‹‰', 'ç´§ç´§åœ°æ‹‰', 'ç”¨ç²—æ©¡çš®ç­‹'], a: 1, exp: 'ç´§=é«˜ã€‚' },
            { type: 'mcq', q: 'å°æç´æ¼”å¥é«˜éŸ³æ—¶ï¼Œæ‰‹æŒ‡åº”è¯¥æŒ‰åœ¨å¼¦çš„ï¼Ÿ', opts: ['ä¸Šç«¯(å¼¦é•¿)', 'ä¸‹ç«¯(å¼¦çŸ­)'], a: 1, exp: 'æœ‰æ•ˆå¼¦é•¿å˜çŸ­ï¼ŒéŸ³å˜é«˜ã€‚' },
            { type: 'matching', q: 'è°æŒ¯åŠ¨å‘å£°ï¼Ÿ', pairs: [{l:'å¼¹å‰ä»–', r:'å¼¦'}, {l:'å¹ç¬›å­', r:'ç©ºæ°”'}, {l:'æ•²é”£', r:'é”£é¢'}], exp: 'å£°æºè¾¨æã€‚' },
            { type: 'mcq', q: 'è¶ŠçŸ­ã€è¶Šç´§ã€è¶Šç»†çš„ç‰©ä½“ï¼ŒæŒ¯åŠ¨è¶Š____ï¼Œå£°éŸ³è¶Š____ã€‚', opts: ['æ…¢ï¼Œä½', 'å¿«ï¼Œé«˜'], a: 1, exp: 'æ€»ç»“è§„å¾‹ã€‚' },
            { type: 'mcq', q: 'è¶Šé•¿ã€è¶Šæ¾ã€è¶Šç²—çš„ç‰©ä½“ï¼ŒæŒ¯åŠ¨è¶Š____ï¼Œå£°éŸ³è¶Š____ã€‚', opts: ['æ…¢ï¼Œä½', 'å¿«ï¼Œé«˜'], a: 0, exp: 'æ€»ç»“è§„å¾‹ã€‚' },
            { type: 'mcq', q: 'è‡ªå·±åˆ¶ä½œå°ä¹å™¨æ—¶ï¼Œç¬¬ä¸€æ­¥åº”è¯¥æ˜¯ï¼Ÿ', opts: ['è®¾è®¡', 'åˆ¶ä½œ', 'å±•ç¤º'], a: 0, exp: 'å·¥ç¨‹è®¾è®¡æµç¨‹ï¼šè®¾è®¡-åˆ¶ä½œ-æµ‹è¯•ã€‚' },
            { type: 'mcq', q: 'å¦‚æœåˆ¶ä½œçš„æ°´ç“¶ç´å£°éŸ³ä¸å‡†ï¼Œåº”è¯¥ï¼Ÿ', opts: ['æ‰”æ‰', 'è°ƒèŠ‚æ°´é‡', 'æ¢ä¸ªç“¶å­'], a: 1, exp: 'è°ƒèŠ‚æ°´é‡æ”¹å˜éŸ³é«˜ã€‚' },
            { type: 'mcq', q: 'å¹å£ç´æ—¶ï¼Œæ°”æµå†²å‡»é•¿çŸ­ä¸åŒçš„ç°§ç‰‡ï¼ŒçŸ­ç°§ç‰‡å‘å‡ºï¼Ÿ', opts: ['ä½éŸ³', 'é«˜éŸ³'], a: 1, exp: 'çŸ­=é«˜ã€‚' },
            { type: 'mcq', q: 'ä¸‹åˆ—å…³äºå£°éŸ³çš„è¯´æ³•æ­£ç¡®çš„æ˜¯ï¼Ÿ', opts: ['åªæœ‰å›ºä½“èƒ½å‘å£°', 'æŒ¯åŠ¨åœæ­¢å£°éŸ³åœæ­¢', 'å£°éŸ³ä¸èƒ½åœ¨æ¶²ä½“ä¸­ä¼ æ’­'], a: 1, exp: 'æŒ¯åŠ¨åœæ­¢å‘å£°åœæ­¢ã€‚' },
            { type: 'fill', q: 'ç®¡å­åº•éƒ¨ç”¨å¡å­å µä½ï¼Œæ˜¯ä¸ºäº†å½¢æˆ____ã€‚', a: ['ç©ºæ°”æŸ±'], exp: 'å½¢æˆå°é—­ç©ºæ°”æŸ±æ‰èƒ½æœ‰æ•ˆæŒ¯åŠ¨ã€‚' }
        ];

        // --- é€»è¾‘æ§åˆ¶ ---
        let currentQIndex = 0;
        let userScoreRaw = 0;
        let userMistakes = [];
        let selectedOption = null;
        let matchState = { left: null, right: null, matchedCount: 0, userPairs: [] };
        
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        function playSound(type) {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.connect(gain); gain.connect(audioCtx.destination);
            const now = audioCtx.currentTime;
            if (type === 'correct') {
                osc.frequency.setValueAtTime(600, now); osc.frequency.exponentialRampToValueAtTime(1200, now + 0.15);
                gain.gain.setValueAtTime(0.1, now); gain.gain.linearRampToValueAtTime(0, now + 0.15);
                osc.start(now); osc.stop(now + 0.15);
            } else if (type === 'wrong') {
                osc.type = 'sawtooth'; osc.frequency.setValueAtTime(150, now); osc.frequency.linearRampToValueAtTime(100, now + 0.2);
                gain.gain.setValueAtTime(0.1, now); gain.gain.linearRampToValueAtTime(0, now + 0.2);
                osc.start(now); osc.stop(now + 0.2);
            } else if (type === 'click') {
                osc.frequency.setValueAtTime(800, now); gain.gain.setValueAtTime(0.02, now); gain.gain.linearRampToValueAtTime(0, now + 0.05);
                osc.start(now); osc.stop(now + 0.05);
            }
        }

        function startQuiz() {
            document.getElementById('section-review').classList.remove('active');
            document.getElementById('section-quiz').classList.add('active');
            renderQuestion();
        }

        function renderQuestion() {
            const qData = quizData[currentQIndex];
            const area = document.getElementById('question-area');
            const nextBtn = document.getElementById('nextBtn');
            
            document.getElementById('q-index').innerText = currentQIndex + 1;
            document.getElementById('progressBar').style.width = ((currentQIndex) / quizData.length * 100) + "%";
            
            area.innerHTML = '';
            nextBtn.disabled = true; nextBtn.style.opacity = 0.5;
            selectedOption = null;

            const card = document.createElement('div');
            card.className = 'question-card';
            
            let tagText = qData.type === 'mcq' ? 'é€‰æ‹©é¢˜' : (qData.type === 'fill' ? 'å¡«ç©ºé¢˜' : 'è¿çº¿é¢˜');
            card.innerHTML = `<div class="q-content"><span class="q-tag">${tagText}</span>${qData.q}</div>`;

            if (qData.type === 'mcq') {
                qData.opts.forEach((opt, idx) => {
                    const btn = document.createElement('div');
                    btn.className = 'option-item'; btn.innerText = opt;
                    btn.onclick = () => selectMCQ(btn, idx);
                    card.appendChild(btn);
                });
            } else if (qData.type === 'fill') {
                const input = document.createElement('input');
                input.className = 'fill-input'; input.type = 'text'; input.placeholder = 'è¾“å…¥ç­”æ¡ˆ';
                input.oninput = (e) => {
                    selectedOption = e.target.value.trim();
                    nextBtn.disabled = !selectedOption;
                    nextBtn.style.opacity = selectedOption ? 1 : 0.5;
                };
                // æ·»åŠ å¤±ç„¦å³æ—¶åé¦ˆ
                input.onblur = () => {
                    if (selectedOption) {
                        const isCorrect = qData.a.some(ans => selectedOption.includes(ans));
                        setTimeout(() => {
                            if (isCorrect) {
                                InstantFeedback.onCorrect(input);
                            } else {
                                InstantFeedback.onWrong(input, qData.exp);
                            }
                        }, 200);
                    }
                };
                card.appendChild(input);
            } else if (qData.type === 'matching') {
                renderMatching(card, qData);
            }
            area.appendChild(card);
        }

        function selectMCQ(el, idx) {
            playSound('click');
            
            // ç§»é™¤å…¶ä»–é€‰é¡¹çš„é€‰ä¸­çŠ¶æ€
            document.querySelectorAll('.option-item').forEach(d => {
                d.classList.remove('selected', 'correct-feedback', 'wrong-feedback');
            });
            el.classList.add('selected');
            selectedOption = idx;
            
            // ç«‹å³æ£€æŸ¥ç­”æ¡ˆå¹¶ç»™å‡ºåé¦ˆ
            const qData = quizData[currentQIndex];
            let isCorrect = false;
            
            if (qData.type === 'fill') {
                if (qData.a.some(ans => idx.includes(ans))) isCorrect = true;
            } else {
                if (idx === qData.a) isCorrect = true;
            }
            
            // å»¶è¿Ÿåé¦ˆï¼Œè®©ç”¨æˆ·çœ‹åˆ°é€‰ä¸­æ•ˆæœ
            setTimeout(() => {
                if (isCorrect) {
                    InstantFeedback.onCorrect(el);
                } else {
                    InstantFeedback.onWrong(el, qData.exp);
                }
            }, 200);
            
            // å¯ç”¨ä¸‹ä¸€é¢˜æŒ‰é’®
            document.getElementById('nextBtn').disabled = false;
            document.getElementById('nextBtn').style.opacity = 1;
        }

        function renderMatching(card, qData) {
            const container = document.createElement('div');
            const leftCol = document.createElement('div'); leftCol.className = 'match-col';
            const rightCol = document.createElement('div'); rightCol.className = 'match-col';
            const row = document.createElement('div'); row.className = 'match-row';

            let rItems = [...qData.pairs].sort(()=>Math.random()-0.5);
            matchState = { left: null, right: null, matchedCount: 0, userPairs: [] };

            qData.pairs.forEach(p => {
                const btn = document.createElement('div');
                btn.className = 'match-btn'; btn.innerText = p.l; btn.dataset.val = p.l; btn.dataset.side = 'left';
                btn.onclick = (e) => handleMatchClick(e.target, qData.pairs.length);
                leftCol.appendChild(btn);
            });
            rItems.forEach(p => {
                const btn = document.createElement('div');
                btn.className = 'match-btn'; btn.innerText = p.r; btn.dataset.val = p.r; btn.dataset.side = 'right';
                btn.onclick = (e) => handleMatchClick(e.target, qData.pairs.length);
                rightCol.appendChild(btn);
            });

            row.appendChild(leftCol); row.appendChild(rightCol);
            card.appendChild(row);
        }

        function handleMatchClick(el, totalPairs) {
            playSound('click');
            const side = el.dataset.side;
            el.parentElement.querySelectorAll('.match-btn').forEach(b => b.classList.remove('selected'));
            el.classList.add('selected');
            
            if (side === 'left') matchState.left = el;
            else matchState.right = el;

            if (matchState.left && matchState.right) {
                matchState.userPairs.push({l: matchState.left.dataset.val, r: matchState.right.dataset.val});
                matchState.left.classList.remove('selected'); matchState.left.classList.add('matched');
                matchState.right.classList.remove('selected'); matchState.right.classList.add('matched');
                matchState.left = null; matchState.right = null;
                matchState.matchedCount++;
                if (matchState.matchedCount === totalPairs) {
                    document.getElementById('nextBtn').disabled = false;
                    document.getElementById('nextBtn').style.opacity = 1;
                }
            }
        }

        function nextQuestion() {
            const qData = quizData[currentQIndex];
            let isCorrect = false;
            let myAns = "";

            if (qData.type === 'mcq') {
                if (selectedOption === qData.a) isCorrect = true;
                myAns = qData.opts[selectedOption];
            } else if (qData.type === 'fill') {
                if (qData.a.some(ans => selectedOption.includes(ans))) isCorrect = true;
                myAns = selectedOption;
            } else if (qData.type === 'matching') {
                let correctCount = 0;
                matchState.userPairs.forEach(up => {
                    if (qData.pairs.some(p => p.l === up.l && p.r === up.r)) correctCount++;
                });
                if (correctCount === qData.pairs.length) isCorrect = true;
                myAns = "é…å¯¹é”™è¯¯";
            }

            if (isCorrect) {
                userScoreRaw++;
                playSound('correct');
            } else {
                playSound('wrong');
                userMistakes.push({ q: qData.q, my: myAns, exp: qData.exp });
            }

            currentQIndex++;
            if (currentQIndex < quizData.length) renderQuestion();
            else showResults();
        }

        function showResults() {
            document.getElementById('section-quiz').classList.remove('active');
            document.getElementById('section-result').classList.add('active');
            
            let finalScore = Math.round((userScoreRaw / quizData.length) * 100);
            let temp = 0;
            const scoreEl = document.getElementById('final-score');
            const timer = setInterval(() => {
                if(temp >= finalScore) { clearInterval(timer); scoreEl.innerText = finalScore; }
                else { temp++; scoreEl.innerText = temp; }
            }, 20);

            const reward = document.getElementById('reward-text');
            if(finalScore === 100) reward.innerText = "ğŸ‰ æ»¡åˆ†ï¼ä½ æ˜¯ä¹å™¨å¤§å¸ˆï¼";
            else if(finalScore >= 80) reward.innerText = "ğŸŒŸ ä¼˜ç§€ï¼å¯¹å¼¦çš„ç§˜å¯†äº†å¦‚æŒ‡æŒï¼";
            else reward.innerText = "ğŸ’ª åŠ æ²¹ï¼è®°ä½ï¼šçŸ­ç´§ç»†å¿«é«˜ï¼";

            if (userMistakes.length > 0) {
                const list = document.getElementById('wrong-list');
                list.style.display = 'block';
                let html = '';
                userMistakes.forEach((m, i) => {
                    html += `<div class="wrong-item"><strong>${i+1}. ${m.q}</strong><br><span style="font-size:0.9em; color:#D32F2F">ä½ çš„å›ç­”ï¼š${m.my}</span><br><span style="font-size:0.9em; color:#388E3C">ğŸ’¡ è§£æï¼š${m.exp}</span></div>`;
                });
                list.innerHTML += html;
            }
        }
    </script>
</body>
</html>